# azure-pipelines.yml
# Pipeline para Azure App Service - Instala npm automaticamente

trigger:
  - main
  - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  nodeVersion: '18.x'
  azureSubscription: 'seu-subscription-id'
  appServiceName: 'seu-app-service-name'
  buildOutputPath: '$(Build.ArtifactStagingDirectory)'

stages:
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: BuildJob
        displayName: 'Build e Teste'
        steps:
          # Setup Node.js
          - task: UseNode@1
            inputs:
              version: $(nodeVersion)
            displayName: 'üì¶ Setup Node.js $(nodeVersion)'

          # Limpar cache npm (recomendado)
          - script: |
              npm cache clean --force
            displayName: 'üßπ Limpar cache npm'
            continueOnError: true

          # Instalar depend√™ncias com npm ci (mais confi√°vel)
          - script: |
              npm ci --production
            displayName: 'üì• Instalar depend√™ncias (npm ci)'
            env:
              npm_config_loglevel: verbose

          # Verificar instala√ß√£o
          - script: |
              npm list --depth=0
            displayName: '‚úÖ Verificar pacotes instalados'

          # Rodar migra√ß√µes (comentado por padr√£o - rodar manualmente primeira vez)
          - script: |
              echo "‚ö†Ô∏è Migra√ß√µes devem ser executadas manualmente na primeira vez"
              echo "Execute no App Service: npm run db:migrate"
            displayName: 'üíæ Info: Migra√ß√µes'

          # Criar arquivo de deploy
          - script: |
              echo "Preparando arquivos para deploy..."
              ls -la
              du -sh .
            displayName: 'üìÇ Preparar arquivos'

          # Publicar artifacts
          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: '$(Build.SourcesDirectory)'
              artifactName: 'passatempo-app'
              publishLocation: 'Container'
            displayName: 'üì§ Publicar artifacts'

  - stage: Deploy
    displayName: 'Deploy Stage'
    condition: succeeded()
    dependsOn: Build
    jobs:
      - deployment: DeployToAzure
        displayName: 'üöÄ Deploy para Azure App Service'
        environment: production
        strategy:
          runOnce:
            deploy:
              steps:
                # Download artifacts
                - task: DownloadBuildArtifacts@0
                  inputs:
                    buildType: 'current'
                    downloadType: 'all'
                  displayName: '‚¨áÔ∏è Download artifacts'

                # Verificar arquivos
                - script: |
                    echo "Arquivos para deploy:"
                    ls -la $(Pipeline.Workspace)/passatempo-app/ | head -20
                    echo "Verificando package.json..."
                    test -f $(Pipeline.Workspace)/passatempo-app/package.json && echo "‚úÖ package.json encontrado" || echo "‚ùå package.json N√ÉO encontrado"
                  displayName: 'üîç Verificar arquivos'

                # Deploy para App Service
                - task: AzureRmWebAppDeployment@4
                  inputs:
                    azureSubscription: $(azureSubscription)
                    appType: 'webAppLinux'
                    WebAppName: $(appServiceName)
                    packageForLinux: '$(Pipeline.Workspace)/passatempo-app'
                    RuntimeStack: 'NODE|18-lts'
                    StartupCommand: 'npm install && npm start'
                    AppSettings: |
                      -DATABASE_HOST $(DATABASE_HOST)
                      -DATABASE_PORT $(DATABASE_PORT)
                      -DATABASE_NAME $(DATABASE_NAME)
                      -DATABASE_USER $(DATABASE_USER)
                      -DATABASE_PASSWORD $(DATABASE_PASSWORD)
                      -JWT_SECRET $(JWT_SECRET)
                      -NODE_ENV production
                      -CORS_ORIGIN $(CORS_ORIGIN)
                      -PORT 8080
                  displayName: 'üöÄ Deploy App Service com npm install'

                # Post-deployment script
                - script: |
                    echo "‚úÖ Deploy conclu√≠do!"
                    echo "Aplica√ß√£o estar√° dispon√≠vel em:"
                    echo "https://$(appServiceName).azurewebsites.net"
                  displayName: '‚ú® Deploy conclu√≠do'
